<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 700 650" style="background: transparent;">
  <defs>
    <marker id="arrow-req" markerWidth="10" markerHeight="10" refX="9" refY="5" orient="auto">
      <path d="M0,0 L10,5 L0,10 L5,5 z" fill="#66b3ff"/>
    </marker>
    <marker id="arrow-err" markerWidth="10" markerHeight="10" refX="9" refY="5" orient="auto">
      <path d="M0,0 L10,5 L0,10 L5,5 z" fill="#ff6666"/>
    </marker>
    <filter id="shadow">
      <feGaussianBlur in="SourceAlpha" stdDeviation="2"/>
      <feOffset dx="1" dy="1" result="offsetblur"/>
      <feComponentTransfer>
        <feFuncA type="linear" slope="0.3"/>
      </feComponentTransfer>
      <feMerge>
        <feMergeNode/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>
  </defs>
  
  <!-- Title -->
  <text x="350" y="30" text-anchor="middle" font-family="monospace" font-size="18" fill="#e0e0e0" font-weight="bold">Request Message Processing Flow</text>
  
  <!-- Start: Message Arrives -->
  <ellipse cx="350" cy="80" rx="80" ry="30" fill="#2a2a3e" stroke="#66b3ff" stroke-width="2" filter="url(#shadow)"/>
  <text x="350" y="85" text-anchor="middle" font-family="monospace" font-size="12" fill="#99ccff">Message Arrives</text>
  
  <!-- dispatcher() -->
  <rect x="250" y="140" width="200" height="60" rx="8" fill="#2a2a3e" stroke="#9966ff" stroke-width="2" filter="url(#shadow)"/>
  <text x="350" y="165" text-anchor="middle" font-family="monospace" font-size="12" fill="#cc99ff" font-weight="bold">dispatcher()</text>
  <text x="350" y="185" text-anchor="middle" font-family="monospace" font-size="10" fill="#b388ff">Message Processing Loop</text>
  
  <!-- process_request(message) -->
  <rect x="250" y="240" width="200" height="50" rx="8" fill="#2a2a3e" stroke="#66ff99" stroke-width="2" filter="url(#shadow)"/>
  <text x="350" y="265" text-anchor="middle" font-family="monospace" font-size="12" fill="#99ffcc">process_request(message)</text>
  
  <!-- validate_schema() -->
  <rect x="250" y="330" width="200" height="50" rx="8" fill="#2a2a3e" stroke="#ffcc66" stroke-width="2" filter="url(#shadow)"/>
  <text x="350" y="355" text-anchor="middle" font-family="monospace" font-size="12" fill="#ffdd99">validate_schema()</text>
  
  <!-- Decision Diamond (represented as polygon) -->
  <polygon points="350,410 420,440 350,470 280,440" fill="#3a3a5e" stroke="#66b3ff" stroke-width="2"/>
  <text x="350" y="445" text-anchor="middle" font-family="monospace" font-size="11" fill="#99ccff">Valid?</text>
  
  <!-- Success Path: receive_request() -->
  <rect x="100" y="510" width="200" height="60" rx="8" fill="#2a2a3e" stroke="#66ff99" stroke-width="2" filter="url(#shadow)"/>
  <text x="200" y="535" text-anchor="middle" font-family="monospace" font-size="12" fill="#99ffcc" font-weight="bold">receive_request()</text>
  <text x="200" y="555" text-anchor="middle" font-family="monospace" font-size="10" fill="#66ff99">Agent Implementation</text>
  
  <!-- send_response() -->
  <rect x="100" y="600" width="200" height="50" rx="8" fill="#2a2a3e" stroke="#66b3ff" stroke-width="2" filter="url(#shadow)" stroke-dasharray="5,3" opacity="0.8"/>
  <text x="200" y="620" text-anchor="middle" font-family="monospace" font-size="12" fill="#99ccff">send_response()</text>
  <text x="200" y="635" text-anchor="middle" font-family="monospace" font-size="10" fill="#66b3ff">Optional Response</text>
  
  <!-- Error Path: Error Handler -->
  <rect x="400" y="510" width="200" height="50" rx="8" fill="#2a2a3e" stroke="#ff6666" stroke-width="2" filter="url(#shadow)"/>
  <text x="500" y="535" text-anchor="middle" font-family="monospace" font-size="12" fill="#ff9999">Error Handler</text>
  
  <!-- Send Error Response -->
  <rect x="400" y="600" width="200" height="50" rx="8" fill="#2a2a3e" stroke="#ff6666" stroke-width="2" filter="url(#shadow)"/>
  <text x="500" y="625" text-anchor="middle" font-family="monospace" font-size="12" fill="#ff9999">Send Error Response</text>
  
  <!-- Arrows -->
  <!-- Main flow -->
  <path d="M 350 110 L 350 140" stroke="#66b3ff" stroke-width="2" marker-end="url(#arrow-req)"/>
  <path d="M 350 200 L 350 240" stroke="#9966ff" stroke-width="2" marker-end="url(#arrow-req)"/>
  <path d="M 350 290 L 350 330" stroke="#66ff99" stroke-width="2" marker-end="url(#arrow-req)"/>
  <path d="M 350 380 L 350 410" stroke="#ffcc66" stroke-width="2" marker-end="url(#arrow-req)"/>
  
  <!-- Success path -->
  <path d="M 280 440 L 200 510" stroke="#66ff99" stroke-width="2" marker-end="url(#arrow-req)"/>
  <text x="220" y="475" font-family="monospace" font-size="10" fill="#66ff99">Valid</text>
  
  <!-- Optional response (dashed) -->
  <path d="M 200 570 L 200 600" stroke="#66b3ff" stroke-width="1.5" stroke-dasharray="5,3" marker-end="url(#arrow-req)"/>
  
  <!-- Error path -->
  <path d="M 420 440 L 500 510" stroke="#ff6666" stroke-width="2" marker-end="url(#arrow-err)"/>
  <text x="470" y="475" font-family="monospace" font-size="10" fill="#ff6666">Invalid</text>
  
  <path d="M 500 560 L 500 600" stroke="#ff6666" stroke-width="2" marker-end="url(#arrow-err)"/>
  
  <!-- Notes -->
  <rect x="30" y="320" width="180" height="70" rx="5" fill="#3a3a4e" stroke="#666" stroke-width="1" opacity="0.9"/>
  <text x="120" y="340" text-anchor="middle" font-family="monospace" font-size="10" fill="#ffdd99" font-weight="bold">Schema validation</text>
  <text x="120" y="355" text-anchor="middle" font-family="monospace" font-size="9" fill="#ccc">ensures message</text>
  <text x="120" y="370" text-anchor="middle" font-family="monospace" font-size="9" fill="#ccc">integrity</text>
  
  <rect x="30" y="480" width="180" height="70" rx="5" fill="#3a3a4e" stroke="#666" stroke-width="1" opacity="0.9"/>
  <text x="120" y="500" text-anchor="middle" font-family="monospace" font-size="10" fill="#99ffcc" font-weight="bold">Custom processing</text>
  <text x="120" y="515" text-anchor="middle" font-family="monospace" font-size="9" fill="#ccc">in agent subclass</text>
  
  <!-- Dotted lines to notes -->
  <path d="M 250 355 L 210 355" stroke="#666" stroke-width="1" stroke-dasharray="2,2"/>
  <path d="M 100 540 L 30 515" stroke="#666" stroke-width="1" stroke-dasharray="2,2"/>
</svg>