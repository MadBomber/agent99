<svg viewBox="0 0 800 600" xmlns="http://www.w3.org/2000/svg" style="background: transparent;">
  <!-- Dark theme styles -->
  <defs>
    <style>
      .title { fill: #e5e7eb; font-family: 'Arial', sans-serif; font-size: 18px; font-weight: bold; }
      .subtitle { fill: #d1d5db; font-family: 'Arial', sans-serif; font-size: 14px; font-weight: bold; }
      .text { fill: #d1d5db; font-family: 'Arial', sans-serif; font-size: 12px; }
      .small-text { fill: #9ca3af; font-family: 'Arial', sans-serif; font-size: 10px; }
      .request-box { fill: #1e40af; stroke: #3b82f6; stroke-width: 2; }
      .response-box { fill: #dc2626; stroke: #ef4444; stroke-width: 2; }
      .control-box { fill: #059669; stroke: #10b981; stroke-width: 2; }
      .process-box { fill: #374151; stroke: #6b7280; stroke-width: 2; }
      .arrow { stroke: #9ca3af; stroke-width: 2; fill: #9ca3af; }
      .validation-box { fill: #7c2d12; stroke: #ea580c; stroke-width: 2; }
    </style>
  </defs>

  <!-- Title -->
  <text x="400" y="30" class="title" text-anchor="middle">Agent99 Message Processing Flow</text>

  <!-- Incoming Messages Section -->
  <text x="50" y="70" class="subtitle">Incoming Messages</text>
  
  <!-- Request Message -->
  <rect x="50" y="90" width="120" height="60" rx="5" class="request-box"/>
  <text x="110" y="110" class="text" text-anchor="middle" fill="white">Request</text>
  <text x="110" y="125" class="text" text-anchor="middle" fill="white">Message</text>
  <text x="110" y="140" class="small-text" text-anchor="middle" fill="#bfdbfe">Client → Agent</text>

  <!-- Response Message -->
  <rect x="200" y="90" width="120" height="60" rx="5" class="response-box"/>
  <text x="260" y="110" class="text" text-anchor="middle" fill="white">Response</text>
  <text x="260" y="125" class="text" text-anchor="middle" fill="white">Message</text>
  <text x="260" y="140" class="small-text" text-anchor="middle" fill="#fecaca">Agent → Client</text>

  <!-- Control Message -->
  <rect x="350" y="90" width="120" height="60" rx="5" class="control-box"/>
  <text x="410" y="110" class="text" text-anchor="middle" fill="white">Control</text>
  <text x="410" y="125" class="text" text-anchor="middle" fill="white">Message</text>
  <text x="410" y="140" class="small-text" text-anchor="middle" fill="#a7f3d0">System Control</text>

  <!-- Arrows pointing down -->
  <path d="M110 160 L110 190" class="arrow" marker-end="url(#arrowhead)"/>
  <path d="M260 160 L260 190" class="arrow" marker-end="url(#arrowhead)"/>
  <path d="M410 160 L410 190" class="arrow" marker-end="url(#arrowhead)"/>

  <!-- Validation Layer -->
  <text x="50" y="220" class="subtitle">Validation &amp; Routing</text>
  
  <!-- Schema Validation -->
  <rect x="50" y="240" width="140" height="50" rx="5" class="validation-box"/>
  <text x="120" y="260" class="text" text-anchor="middle" fill="white">Schema</text>
  <text x="120" y="275" class="text" text-anchor="middle" fill="white">Validation</text>

  <!-- Message Router -->
  <rect x="220" y="240" width="140" height="50" rx="5" class="process-box"/>
  <text x="290" y="260" class="text" text-anchor="middle" fill="white">Message</text>
  <text x="290" y="275" class="text" text-anchor="middle" fill="white">Router</text>

  <!-- Error Handler -->
  <rect x="390" y="240" width="140" height="50" rx="5" class="validation-box"/>
  <text x="460" y="260" class="text" text-anchor="middle" fill="white">Error</text>
  <text x="460" y="275" class="text" text-anchor="middle" fill="white">Handler</text>

  <!-- Arrows from validation to handlers -->
  <path d="M120 300 L120 330" class="arrow" marker-end="url(#arrowhead)"/>
  <path d="M290 300 L290 330" class="arrow" marker-end="url(#arrowhead)"/>
  <path d="M460 300 L460 330" class="arrow" marker-end="url(#arrowhead)"/>

  <!-- Processing Handlers -->
  <text x="50" y="360" class="subtitle">Message Handlers</text>
  
  <!-- Request Handler -->
  <rect x="50" y="380" width="140" height="80" rx="5" class="request-box"/>
  <text x="120" y="400" class="text" text-anchor="middle" fill="white">receive_request</text>
  <text x="120" y="415" class="small-text" text-anchor="middle" fill="#bfdbfe">• Validate payload</text>
  <text x="120" y="430" class="small-text" text-anchor="middle" fill="#bfdbfe">• Process action</text>
  <text x="120" y="445" class="small-text" text-anchor="middle" fill="#bfdbfe">• Send response</text>

  <!-- Response Handler -->
  <rect x="220" y="380" width="140" height="80" rx="5" class="response-box"/>
  <text x="290" y="400" class="text" text-anchor="middle" fill="white">receive_response</text>
  <text x="290" y="415" class="small-text" text-anchor="middle" fill="#fecaca">• Process result</text>
  <text x="290" y="430" class="small-text" text-anchor="middle" fill="#fecaca">• Trigger follow-up</text>
  <text x="290" y="445" class="small-text" text-anchor="middle" fill="#fecaca">• Update state</text>

  <!-- Control Handler -->
  <rect x="390" y="380" width="140" height="80" rx="5" class="control-box"/>
  <text x="460" y="395" class="small-text" text-anchor="middle" fill="white">Control Actions:</text>
  <text x="460" y="410" class="small-text" text-anchor="middle" fill="#a7f3d0">• handle_shutdown</text>
  <text x="460" y="425" class="small-text" text-anchor="middle" fill="#a7f3d0">• handle_pause</text>
  <text x="460" y="440" class="small-text" text-anchor="middle" fill="#a7f3d0">• handle_resume</text>
  <text x="460" y="455" class="small-text" text-anchor="middle" fill="#a7f3d0">• handle_status</text>

  <!-- Final Processing -->
  <path d="M120 470 L120 510" class="arrow" marker-end="url(#arrowhead)"/>
  <path d="M290 470 L290 510" class="arrow" marker-end="url(#arrowhead)"/>
  <path d="M460 470 L460 510" class="arrow" marker-end="url(#arrowhead)"/>

  <!-- Results -->
  <text x="50" y="540" class="subtitle">Results</text>
  
  <rect x="50" y="560" width="120" height="30" rx="5" class="process-box"/>
  <text x="110" y="580" class="small-text" text-anchor="middle" fill="white">Response Sent</text>

  <rect x="200" y="560" width="120" height="30" rx="5" class="process-box"/>
  <text x="260" y="580" class="small-text" text-anchor="middle" fill="white">Action Completed</text>

  <rect x="350" y="560" width="120" height="30" rx="5" class="process-box"/>
  <text x="410" y="580" class="small-text" text-anchor="middle" fill="white">State Updated</text>

  <!-- Error Flow -->
  <path d="M190 265 L350 265" class="arrow" stroke="#ef4444" stroke-dasharray="5,5"/>
  <text x="270" y="260" class="small-text" fill="#ef4444">validation fails</text>

  <!-- Arrow marker definition -->
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#9ca3af"/>
    </marker>
  </defs>

  <!-- Legend -->
  <rect x="550" y="90" width="200" height="180" rx="5" fill="none" stroke="#6b7280" stroke-width="1" stroke-dasharray="3,3"/>
  <text x="560" y="110" class="subtitle">Message Types</text>
  
  <rect x="560" y="120" width="15" height="15" class="request-box"/>
  <text x="580" y="132" class="small-text">Request Messages</text>
  
  <rect x="560" y="140" width="15" height="15" class="response-box"/>
  <text x="580" y="152" class="small-text">Response Messages</text>
  
  <rect x="560" y="160" width="15" height="15" class="control-box"/>
  <text x="580" y="172" class="small-text">Control Messages</text>
  
  <rect x="560" y="180" width="15" height="15" class="process-box"/>
  <text x="580" y="192" class="small-text">Processing Steps</text>
  
  <rect x="560" y="200" width="15" height="15" class="validation-box"/>
  <text x="580" y="212" class="small-text">Validation/Errors</text>
  
  <text x="560" y="230" class="subtitle">Flow Types</text>
  <line x1="560" y1="240" x2="580" y2="240" class="arrow"/>
  <text x="585" y="244" class="small-text">Normal Flow</text>
  
  <line x1="560" y1="250" x2="580" y2="250" stroke="#ef4444" stroke-dasharray="3,3" stroke-width="2"/>
  <text x="585" y="254" class="small-text">Error Flow</text>
</svg>